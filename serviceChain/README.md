# 地理空间数据处理任务链构建系统

这是一个基于大模型的自动任务链构建系统，可以根据用户需求自动构建地理空间数据处理任务链，并允许用户编辑任务链节点。

## 功能特点

- 基于大模型自动构建任务链
- 可视化编辑任务链节点
- 数据上传与管理
- 保存和加载任务链
- 执行任务链
- 支持多种地理空间数据处理操作

## 系统架构

系统由以下几个部分组成：

1. **TaskChainBuilder.py**: 核心任务链构建和执行模块
2. **TaskChainUI.py**: 基于Gradio的Web界面
3. **geoUtiles.py**: 地理空间数据处理工具库

## 目录结构

```
serviceChain/
  ├── geoUtiles.py         # 地理空间数据处理工具库
  ├── TaskChainBuilder.py  # 任务链构建和执行模块
  ├── TaskChainUI.py       # Web界面
  ├── README.md            # 说明文档
  ├── data/                # 数据存储目录
  ├── output/              # 输出结果存储目录
  └── task_chains/         # 任务链配置文件存储目录
```

## 安装依赖

```bash
pip install fastapi qwen-agent gradio opencv-python numpy gdal
```

## 使用方法

### 启动Web界面

```bash
python TaskChainUI.py
```

启动后，可以通过浏览器访问 http://localhost:7866 使用系统。

### 构建任务链

1. 在"构建任务链"标签页中，输入处理需求，例如：
   ```
   读取一个TIF图像，进行裁剪，然后拼接回原图，最后保存为JPG格式
   ```
2. 点击"构建任务链"按钮，系统会自动生成任务链

### 数据管理

在"数据管理"标签页中，可以：

1. 上传一个或多个数据文件
2. 系统会自动将数据文件复制到data目录
3. 任务链中的读取节点会自动更新数据路径

**注意**：上传数据是执行任务链的必要步骤。如果没有上传数据，任务链将无法正确执行。

### 编辑任务链

在"编辑任务链"标签页中，可以：

- 查看当前任务链详细信息
- 编辑节点参数
  - 从函数下拉列表中选择函数，自动获取函数描述
  - 以JSON格式编辑参数
- 添加新节点
- 移除节点
- 添加节点之间的连接
- 移除节点之间的连接

### 保存和加载任务链

在"保存/加载任务链"标签页中，可以：

- 将当前任务链保存到文件（默认保存到task_chains目录）
- 从文件加载任务链（默认从task_chains目录加载）

只需输入文件名即可，系统会自动处理路径和扩展名。

### 执行任务链

在"执行任务链"标签页中：

1. 确保已上传数据
2. 点击"执行任务链"按钮
3. 系统会按照任务链定义的顺序执行各个节点
4. 处理结果会保存到output目录

## 可用函数

系统支持以下地理空间数据处理函数：

- `readImg`: 读取图像文件或目录中的图像
- `saveImg`: 保存图像到指定路径
- `cropImg`: 裁剪图像为小块
- `stitchImg`: 将裁剪的小块图像拼接回原图
- `truncatedLinearStretch`: 对图像进行线性拉伸处理
- `assignGeoreference`: 为图像赋予地理参考信息
- `tif2shp`: 将TIF影像转换为Shapefile格式
- `appendImagesFrom`: 从指定字典追加图像

## 工作流示例

### 示例1：读取、裁剪、拼接、保存流程

1. 构建任务链：输入"读取一个TIF图像，进行裁剪，然后拼接回原图，最后保存为JPG格式"
2. 上传TIF图像文件
3. 任务链节点：
   - 读取图像 → 裁剪图像 → 拼接图像 → 保存图像
4. 执行任务链
5. 查看output目录中的结果

### 示例2：影像格式转换流程

1. 构建任务链：输入"读取一个TIF图像，进行线性拉伸，赋予地理信息，最后保存为TIF格式"
2. 上传TIF图像文件
3. 任务链节点：
   - 读取图像 → 线性拉伸 → 赋予地理信息 → 保存图像
4. 执行任务链
5. 查看output目录中的结果

## 注意事项

- 确保上传正确格式的数据文件
- 确保有足够的磁盘空间保存处理结果
- 对于大型图像，处理可能需要较长时间
- 编辑节点参数时，请遵循正确的JSON格式 